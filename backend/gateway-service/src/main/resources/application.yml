spring:
  main:
    web-application-type: reactive

  application:
    name: ${APPLICATION_SERVICE_NAME:gateway-service}

  data:
    redis:
      host: ${DATA_REDIS_HOST}
      port: ${DATA_REDIS_PORT}

  config:
    import: "optional:configserver:"

  cloud:
    config:
      enabled: false

    gateway:
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
        - PreserveHostHeader
      httpclient:
        wiretap: true
      filter:
        remove-hop-by-hop: false
      forwarded:
        enabled: true
      globalcors:
        add-to-simple-url-handler-mapping: true
        corsConfigurations:
          "[/**]":
            allowedOrigins: "${APP_FRONTEND_URL:http://localhost:3000}"
            allowedMethods: "*"
            allowedHeaders: "*"
            allowCredentials: true
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        - id: auth-service
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

        - id: auth-internal
          uri: lb://auth-service
          predicates:
            - Path=/internal/**

        - id: user-profile-service
          uri: lb://user-profile-service
          predicates:
            - Path=/api/profiles/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

        - id: catalog-service
          uri: lb://catalog-service
          predicates:
            - Path=/api/catalog/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

        - id: billing-service
          uri: lb://billing-service
          predicates:
            - Path=/api/billing/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

        - id: learning-analytics-service
          uri: lb://learning-analytics-service
          predicates:
            - Path=/api/learning-analytics/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

        - id: content-service
          uri: lb://content-service
          predicates:
            - Path=/api/content/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/notifications/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

        - id: file-service
          uri: lb://file-service
          predicates:
            - Path=/api/files/**
          filters:
            - StripPrefix=1
          metadata:
            sensitive-headers: [ ]

  webflux:
    cors:
      mappings:
        "[/**]":
          allowedOrigins: "*"
          allowedMethods: "*"
          allowedHeaders: "*"

server:
  port: ${SERVER_PORT}
  error:
    whitelabel:
      enabled: false

eureka:
  client:
    fetch-registry: true
    register-with-eureka: true
    service-url:
      defaultZone: ${EUREKA_CLIENT_DEFAULT_ZONE}
  instance:
    prefer-ip-address: true

management:
  endpoints:
    web:
      exposure:
        include: "health,info,metrics,loggers,gateway"
  endpoint:
    health:
      show-details: always # when_authorized
  health:
    mail:
      enabled: false

# ====== Sécurité JWT côté gateway ======
jwt:
  secret:
    current: ${JWT_SECRET_CURRENT}
    previous: ${JWT_SECRET_PREVIOUS:${JWT_SECRET_CURRENT}}
  expiration: ${JWT_EXPIRATION}
  refresh:
    expiration: ${JWT_REFRESH_EXPIRATION}

  public-paths:
    # variantes /api/*
    - /api/auth/login
    - /api/auth/register
    - /api/auth/verify
    - /api/auth/refresh
    - /api/auth/forgot-password
    - /api/auth/reset-password
    - /api/actuator/**

    # Billing  publics
    - /api/billing/customers/ensure
    - /api/billing/webhook


    # Profile User publics
    - /api/profiles/public/**
    - /profiles/public/**
    - /api/profiles/user/*/stripe-customer

    # Catalog publics
    - /api/catalog/public/**
    - /catalog/public/**
#      - /api/catalog/courses
#      - /api/catalog/courses/**
#      - /api/catalog/domains
#      - /api/catalog/categories

    # Notification publics
    - /api/notifications/newsletter/subscribe
    - /notifications/newsletter/subscribe
    - /api/notifications/newsletter/confirm
    - /notifications/newsletter/confirm
    - /api/notifications/contact
    - /notifications/contact


    # Content publics
    - /api/content/features
    - /content/features
    - /api/content/pages/**
    - /content/pages/**

    - /api/content/companies/links
    - /content/companies/links
    - /api/content/companies/links/unlinked
    - /content/companies/links/unlinked
    - /content/companies/company

    # variantes sans /api (après StripPrefix)
    - /auth/login
    - /auth/register
    - /auth/verify
    - /auth/refresh
    - /auth/forgot-password
    - /auth/reset-password
    - /actuator/**
    - /profiles/user/*/stripe-customer
    - /billing/customers/ensure
    - /billing/webhook


gateway:
  trust:
    secret: ${GATEWAY_TRUST_SECRET}
  session:
    status-url: lb://auth-service/internal/sessions/{sessionId}/status

internal:
  secret: ${INTERNAL_SECRET}

logging:
  level:
    org.springframework.cloud.gateway.filter.ratelimit: DEBUG
    com.codeandskills.gateway_service: DEBUG