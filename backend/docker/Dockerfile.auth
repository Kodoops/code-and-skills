# √âtape 1 : build avec Maven + JDK 21 (Amazon Corretto)
FROM amazoncorretto:21-alpine3.19 AS builder

# Installer Maven
RUN apk add --no-cache maven

WORKDIR /build

# üß© Copie du pom parent (backend) + modules n√©cessaires
COPY pom.xml .
COPY common ./common
COPY auth-service ./auth-service

# üß† Installer d'abord le parent dans le repo Maven local
RUN mvn -N install

# üì¶ Installer le module commun
RUN mvn -f common/pom.xml clean install -DskipTests

# ‚öôÔ∏è Compiler le service d‚Äôauthentification
RUN mvn -f auth-service/pom.xml clean package -DskipTests

# √âtape 2 : image finale all√©g√©e
FROM amazoncorretto:21-alpine3.19
WORKDIR /app
COPY --from=builder /build/auth-service/target/*.jar app.jar
EXPOSE 8081
ENTRYPOINT ["java", "-jar", "app.jar"]